(this["webpackJsonpcascade-client"]=this["webpackJsonpcascade-client"]||[]).push([[0],{29:function(e,t,n){e.exports=n(72)},34:function(e,t,n){},59:function(e,t){},61:function(e,t){},70:function(e,t,n){},71:function(e,t,n){},72:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),c=n(27),o=n.n(c),i=(n(34),n(1)),u=n(4),s=n(2),l=n(28),d=n.n(l),m={myId:null,myStream:null,order:[],peers:{},server:null,streams:{},videoElement:null};function f(e,t){console.log("ACTION",t);var n=e.streams;switch(t.type){case"MY_ID_SET":return Object(s.a)({},e,{myId:t.id});case"MY_STREAM_SET":return function(e,t){var n=e.myStream,a=e.peers,r=t.stream;Object.values(a).forEach((function(e){e.removeStream(n),e.addStream(r)}))}(e,t),Object(s.a)({},e,{myStream:t.stream});case"ORDER_SET":return Object(s.a)({},e,{order:t.order});case"SERVER_MESSAGE":return function(e,t){var n=e.myStream,a=e.peers,r=e.server,c=t.data,o=t.dispatch,i=JSON.parse(c),l=i.forId,m=i.fromId,f=i.order,E=i.signal,v=i.type;if("id"===v)o({type:"MY_ID_SET",id:l});else if("order"===v)o({type:"ORDER_SET",order:f});else if("signal"===v){var b="initiate"===E,O=!Object.keys(a).includes(m),p=O?new d.a({initiator:b,stream:n}):a[m];if(O&&(p.on("signal",(function(e){r.send(JSON.stringify({type:"signal",forId:m,fromId:l,signal:e}))})),p.on("stream",(function(e){o({type:"STREAMS_ADD",id:m,stream:e})}))),b||p.signal(E),O)return Object(s.a)({},e,{peers:Object(s.a)({},a,Object(u.a)({},m,p))})}return e}(e,t);case"SERVER_SET":return Object(s.a)({},e,{server:t.server});case"STREAMS_ADD":return Object(s.a)({},e,{streams:Object(s.a)({},n,Object(u.a)({},t.id,t.stream))});case"VIDEO_ELEMENT_SET":return Object(s.a)({},e,{videoElement:t.videoElement});default:return console.error("Unknown action:",t),e}}var E=Object(a.createContext)(m),v=function(e){var t=e.children,n=Object(a.useReducer)(f,m),c=Object(i.a)(n,2),o=c[0],u=c[1];return r.a.createElement(E.Provider,{value:[o,u]},t)},b=n(15),O=n(11),p=n.n(O),j=n(14),S=function(){var e=Object(a.useContext)(E),t=Object(i.a)(e,2),n=t[0],c=t[1],o=n.myStream,l=n.videoElement,d=Object(a.useState)([]),m=Object(i.a)(d,2),f=m[0],v=m[1],O=Object(a.useState)(!0),S=Object(i.a)(O,2),y=S[0],h=S[1],g=Object(a.useState)(null),w=Object(i.a)(g,2),k=w[0],x=w[1],I=Object(a.useState)(null),R=Object(i.a)(I,2),T=R[0],_=R[1],M=Object(a.useState)(null),A=Object(i.a)(M,2),C=A[0],D=A[1],L=function(){var e=Object(j.a)(p.a.mark((function e(){var t,n,a;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o&&o.getTracks().forEach((function(e){return e.stop()})),e.next=3,navigator.mediaDevices.getUserMedia({audio:{autoGainControl:{exact:!1},deviceId:k&&{exact:k},echoCancellation:!1,noiseSuppression:{exact:!1}},video:{deviceId:C&&{exact:C}}});case 3:t=e.sent,n=window.AudioContext||window.webkitAudioContext,a=new n,a.createMediaStreamSource(t).connect(a.destination),c({type:"MY_STREAM_SET",stream:t});case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();Object(a.useEffect)((function(){o&&function(){var e=Object(j.a)(p.a.mark((function e(){var t;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,v(t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()()}),[o]),Object(a.useEffect)((function(){L()}),[k,C]),Object(a.useEffect)((function(){l&&T&&l.setSinkId(T)}),[T,l]);var V=["audioinput","audiooutput","videoinput"],N=["Audio Input","Audio Output","Video Input"],U=[[k,x],[T,_],[C,D]],Y=f.reduce((function(e,t){var n=t.deviceId,a=t.kind,r=V.indexOf(a);return[].concat(Object(b.a)(e.slice(0,r)),[Object(s.a)({},e[r],Object(u.a)({},n,t))],Object(b.a)(e.slice(r+1)))}),[{},{},{}]);return y?r.a.createElement(r.a.Fragment,null,Y.map((function(e,t){var n=N[t],a=Object(i.a)(U[t],2),c=a[0],o=a[1];return r.a.createElement("label",{key:n},n,r.a.createElement("select",{onChange:function(e){return o(e.target.value)},value:c||"default"},Object.values(e).map((function(e){var t=e.deviceId,n=e.label;return r.a.createElement("option",{key:t,value:t},n)}))))})),r.a.createElement("button",{onClick:function(){return h(!1)}},"x")):r.a.createElement("button",{onClick:function(){return h(!0)}},"Audio/Video settings")},y=function(){var e=Object(a.useState)(!0),t=Object(i.a)(e,2),n=t[0],c=t[1],o=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",null,"Welcome. Let's make the connections."),r.a.createElement("div",null,"First, enable your audio and video. Before you click the button, put on headphones so there's no feedback!"),r.a.createElement("button",{onClick:function(){return c(!1)}},"Let's go!")),u={alignItems:"center",display:"flex",flexDirection:n?"column":"row"};return n||(u.bottom="0",u.justifyContent="space-between",u.position="absolute",u.width="100%"),r.a.createElement("section",{style:u},n?o:r.a.createElement(S,null))},h=function(e){var t=e.id,n=e.isMe,c=e.stream,o=Object(a.useContext)(E),u=Object(i.a)(o,2),s=u[0],l=u[1],d=s.order,m=Object(a.useCallback)((function(e){e&&("srcObject"in e?e.srcObject=c:e.src=URL.createObjectURL(c),n&&l({type:"VIDEO_ELEMENT_SET",videoElement:e}))}),[c]),f=d.findIndex((function(e){return t===e}))+1,v={order:f,position:"relative"};n&&(v.display="flex",v.flexDirection="column");return r.a.createElement("div",{style:v},c&&r.a.createElement("video",{autoPlay:!0,muted:n,ref:m}),n&&r.a.createElement(y,null),c&&r.a.createElement("span",{style:{left:0,position:"absolute",top:0}},f))};n(70);var g=function(){var e=Object(a.useContext)(E),t=Object(i.a)(e,2),n=t[0],c=t[1];console.log("STATE",n);var o=n.myId,u=n.myStream,s=n.streams,l=function(e){var t=Object(a.useRef)();return Object(a.useEffect)((function(){t.current=e}),[e]),t.current}(u),d=new URLSearchParams(window.location.search).get("server");return Object(a.useEffect)((function(){if(u&&!l&&d){var e=new WebSocket(d);e.addEventListener("close",(function(){return console.log("closing socket")})),e.addEventListener("error",(function(){return console.log("socket error")})),e.addEventListener("open",(function(){return console.log("opening socket")})),e.addEventListener("message",(function(e){var t=e.data;c({type:"SERVER_MESSAGE",data:t,dispatch:c})})),c({type:"SERVER_SET",server:e})}}),[u,l,d]),d?r.a.createElement("main",{className:"videos"},r.a.createElement(h,{isMe:!0,id:o,stream:u}),Object.entries(s).map((function(e){var t=Object(i.a)(e,2),n=t[0],a=t[1];return r.a.createElement(h,{key:n,id:n,stream:a})}))):"You have to have a server. Sorry, that's just the way it is."},w=(n(71),function(){return r.a.createElement(v,null,r.a.createElement(g,null))});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(r.a.createElement(w,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[29,1,2]]]);
//# sourceMappingURL=main.49768f6a.chunk.js.map