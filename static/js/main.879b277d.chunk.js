(this["webpackJsonpcascade-client"]=this["webpackJsonpcascade-client"]||[]).push([[0],{44:function(e,t,n){e.exports=n(87)},49:function(e,t,n){},74:function(e,t){},76:function(e,t){},86:function(e,t,n){},87:function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),c=n(38),o=n.n(c),i=(n(49),n(89)),u=n(41),s=n(2),l=n(5),d=n(3),m=n(39),f=n.n(m);function b(e,t){e.send(JSON.stringify(t))}var E={iAmInitiator:!1,myId:null,myStream:null,order:[],peers:{},server:null,streams:{},videoElements:{}};function v(e,t){console.log("ACTION",t);var n=e.myId,r=e.order,a=e.server,c=e.streams;switch(t.type){case"MY_ID_SET":return Object(d.a)({},e,{myId:t.id});case"MY_STREAM_SET":return function(e,t){var n=e.myStream,r=e.peers,a=t.stream;Object.values(r).forEach((function(e){e.removeStream(n),e.addStream(a)}))}(e,t),Object(d.a)({},e,{myStream:t.stream});case"ORDER_SEND":return b(a,{type:"order",fromId:n,order:r}),e;case"ORDER_SET":var o=t.order,i=0===o.findIndex((function(e){return n===e}));return Object(d.a)({},e,{iAmInitiator:i,order:o});case"SERVER_MESSAGE":return function(e,t){var n=e.myStream,r=e.peers,a=e.server,c=t.data,o=t.dispatch,i=JSON.parse(c),u=i.forId,s=i.fromId,m=i.order,E=i.signal,v=i.type;if("id"===v)o({type:"MY_ID_SET",id:u});else if("order"===v)o({type:"ORDER_SET",order:m});else if("signal"===v){var O="initiate"===E,p=!Object.keys(r).includes(s),j=p?new f.a({initiator:O,stream:n}):r[s];if(p&&(j.on("signal",(function(e){b(a,{type:"signal",forId:s,fromId:u,signal:e})})),j.on("stream",(function(e){o({type:"STREAMS_ADD",id:s,stream:e})}))),O||j.signal(E),p)return Object(d.a)({},e,{peers:Object(d.a)({},r,Object(l.a)({},s,j))})}return e}(e,t);case"SERVER_SET":return Object(d.a)({},e,{server:t.server});case"STREAMS_ADD":return Object(d.a)({},e,{streams:Object(d.a)({},c,Object(l.a)({},t.id,t.stream))});case"VIDEO_ELEMENT_SET":return Object(d.a)({},e,{videoElements:Object(l.a)({},t.id,t.videoElement)});default:return console.error("Unknown action:",t),e}}var O=Object(r.createContext)(E),p=function(e){var t=e.children,n=Object(r.useReducer)(v,E),c=Object(s.a)(n,2),o=c[0],i=c[1];return a.a.createElement(O.Provider,{value:[o,i]},t)},j=n(17),g=n(90),S=n(91),y=n(18),h=n.n(y),w=n(24),I=new(window.AudioContext||window.webkitAudioContext),R=function(){var e=Object(r.useContext)(O),t=Object(s.a)(e,2),n=t[0],c=t[1],o=n.myStream,i=n.videoElements,u=Object(r.useState)([]),m=Object(s.a)(u,2),f=m[0],b=m[1],E=Object(r.useState)(!1),v=Object(s.a)(E,2),p=v[0],g=v[1],S=Object(r.useState)(null),y=Object(s.a)(S,2),R=y[0],k=y[1],x=Object(r.useState)(null),C=Object(s.a)(x,2),D=C[0],T=C[1],_=Object(r.useState)(null),M=Object(s.a)(_,2),A=M[0],L=M[1],N=function(){var e=Object(w.a)(h.a.mark((function e(){var t;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o&&o.getTracks().forEach((function(e){return e.stop()})),e.next=3,navigator.mediaDevices.getUserMedia({audio:{autoGainControl:{exact:!1},deviceId:R&&{exact:R},echoCancellation:!1,noiseSuppression:{exact:!1}},video:{deviceId:A&&{exact:A}}});case 3:t=e.sent,I.createMediaStreamSource(t).connect(I.destination),c({type:"MY_STREAM_SET",stream:t});case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();Object(r.useEffect)((function(){o&&p&&function(){var e=Object(w.a)(h.a.mark((function e(){var t;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,b(t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()()}),[o,p]),Object(r.useEffect)((function(){N()}),[R,A]),Object(r.useEffect)((function(){var e=Object.values(i);e.length&&D&&e.setSinkId(D)}),[D,i]);var V=["audioinput","audiooutput","videoinput"],U=["Audio Input","Audio Output","Video Input"],Y=[[R,k],[D,T],[A,L]],F=f.reduce((function(e,t){var n=t.deviceId,r=t.kind,a=V.indexOf(r);return[].concat(Object(j.a)(e.slice(0,a)),[Object(d.a)({},e[a],Object(l.a)({},n,t))],Object(j.a)(e.slice(a+1)))}),[{},{},{}]);return p?a.a.createElement(a.a.Fragment,null,F.map((function(e,t){var n=Object.values(e);if(0===n.length)return null;var r=U[t],c=Object(s.a)(Y[t],2),o=c[0],i=c[1];return a.a.createElement("label",{key:r},r,a.a.createElement("select",{onChange:function(e){return i(e.target.value)},value:o||"default"},n.map((function(e){var t=e.deviceId,n=e.label;return a.a.createElement("option",{key:t,value:t},n)}))))})),a.a.createElement("button",{onClick:function(){return g(!1)}},"x")):a.a.createElement("button",{onClick:function(){return g(!0)}},"Audio/Video settings")},k=function(){var e=Object(r.useState)(!0),t=Object(s.a)(e,2),n=t[0],c=t[1],o=a.a.createElement(a.a.Fragment,null,a.a.createElement("div",null,"Welcome. Let's make the connections."),a.a.createElement("div",null,"First, enable your audio and video. Before you click the button, put on headphones so there's no feedback!"),a.a.createElement("button",{onClick:function(){return c(!1)}},"Let's go!")),i=Object(d.a)({alignItems:"center",display:"flex",flexDirection:n?"column":"row"},n?{}:{bottom:0,justifyContent:"space-between",position:"absolute"});return a.a.createElement("section",{style:i},n?o:a.a.createElement(R,null))},x=function(e){var t=e.orderNumber,n=Object(r.useContext)(O),c=Object(s.a)(n,1)[0],o=c.myId;return c.stream&&o?a.a.createElement("span",{style:{alignItems:"center",backgroundColor:"white",border:"1px solid black",borderRadius:"50%",display:"flex",height:"2rem",justifyContent:"center",left:"1%",position:"absolute",top:"2%",width:"2rem"}},t):null},C=function(e){var t=e.id,n=e.isMe,c=e.numColumns,o=e.stream,i=Object(r.useContext)(O),u=Object(s.a)(i,2),l=u[0],d=u[1],m=l.iAmInitiator,f=l.order,b=Object(r.useCallback)((function(e){e&&("srcObject"in e?e.srcObject=o:e.src=URL.createObjectURL(o),d({type:"VIDEO_ELEMENT_SET",id:t,videoElement:e}))}),[o]),E=Object(r.useRef)(null),v=Object(g.a)({item:{id:t,type:"participant"},canDrag:function(){return m},collect:function(e){return{isDragging:e.isDragging()}}}),p=Object(s.a)(v,2),y=p[0].isDragging,h=p[1],w=Object(S.a)({accept:"participant",drop:function(e){d({type:"ORDER_SEND"})},hover:function(e){var n=e.id;if(n!==t){var r=f.indexOf(t),a=f.indexOf(n),c=Object(j.a)(f);c[r]=n,c[a]=t,d({type:"ORDER_SET",order:c})}}}),I=Object(s.a)(w,2)[1];h(E),I(E);var R=f.findIndex((function(e){return t===e}))+1,C=Math.ceil(R/c),D={gridColumn:"".concat(R-(C-1)*c," / span 1"),gridRow:"".concat(C," / span 1"),opacity:y?.5:1,position:"relative"};return a.a.createElement("div",{ref:E,style:D},o&&a.a.createElement("video",{autoPlay:!0,muted:n,ref:b}),n&&a.a.createElement(k,null),a.a.createElement(x,{orderNumber:R}))},D=function(){var e=Object(r.useContext)(O),t=Object(s.a)(e,1)[0];console.log("STATE",t);var n=t.iAmInitiator,c=t.myId,o=t.myStream,i=t.order,u=t.streams,l=i.length||1,d=Math.ceil(Math.sqrt(l)),m=Math.ceil(l/d),f=100/d,b=100/m,E={display:"grid",flex:1,gridTemplateColumns:"repeat(".concat(d,", ").concat(f,"%)"),gridTemplateRows:"repeat(".concat(d,", ").concat(b,"%)")},v=Object.entries(u);return a.a.createElement(a.a.Fragment,null,a.a.createElement("main",{style:E},a.a.createElement(C,{isMe:!0,id:c,numColumns:d,stream:o}),v.map((function(e){var t=Object(s.a)(e,2),n=t[0],r=t[1];return a.a.createElement(C,{key:n,id:n,numColumns:d,stream:r})}))),a.a.createElement("nav",null,n&&u.length>0&&a.a.createElement("button",{className:"big-go-button"},"GO")))};var T=function(e){var t=e.children,n=Object(r.useContext)(O),a=Object(s.a)(n,2),c=a[0],o=a[1],i=c.myStream,u=function(e){var t=Object(r.useRef)();return Object(r.useEffect)((function(){t.current=e}),[e]),t.current}(i),l=new URLSearchParams(window.location.search).get("server");return Object(r.useEffect)((function(){if(i&&!u&&l){var e=new WebSocket(l);e.addEventListener("close",(function(){return console.log("closing socket")})),e.addEventListener("error",(function(){return console.log("socket error")})),e.addEventListener("open",(function(){return console.log("opening socket")})),e.addEventListener("message",(function(e){var t=e.data;o({type:"SERVER_MESSAGE",data:t,dispatch:o})})),o({type:"SERVER_SET",server:e})}}),[i,u,l]),l?t:"You have to have a server. Sorry, that's just the way it is."},_=(n(86),function(){return a.a.createElement(p,null,a.a.createElement(T,null,a.a.createElement(i.a,{backend:u.a},a.a.createElement(D,null))))});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(a.a.createElement(_,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[44,1,2]]]);
//# sourceMappingURL=main.879b277d.chunk.js.map