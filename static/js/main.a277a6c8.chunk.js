(this["webpackJsonpcascade-client"]=this["webpackJsonpcascade-client"]||[]).push([[0],{44:function(e,t,n){e.exports=n(87)},49:function(e,t,n){},74:function(e,t){},76:function(e,t){},86:function(e,t,n){},87:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),c=n(38),o=n.n(c),i=(n(49),n(89)),s=n(41),u=n(2),l=n(6),d=n(3),m=n(39),f=n.n(m),v={myId:null,myStream:null,order:[],peers:{},server:null,streams:{},videoElements:{}};function E(e,t){e.send(JSON.stringify(t))}function b(e,t){console.log("ACTION",t);var n=e.myId,a=e.order,r=e.server,c=e.streams;switch(t.type){case"MY_ID_SET":return Object(d.a)({},e,{myId:t.id});case"MY_STREAM_SET":return function(e,t){var n=e.myStream,a=e.peers,r=t.stream;Object.values(a).forEach((function(e){e.removeStream(n),e.addStream(r)}))}(e,t),Object(d.a)({},e,{myStream:t.stream});case"ORDER_SEND":return E(r,{type:"order",fromId:n,order:a}),e;case"ORDER_SET":return Object(d.a)({},e,{order:t.order});case"SERVER_MESSAGE":return function(e,t){var n=e.myStream,a=e.peers,r=e.server,c=t.data,o=t.dispatch,i=JSON.parse(c),s=i.forId,u=i.fromId,m=i.order,v=i.signal,b=i.type;if("id"===b)o({type:"MY_ID_SET",id:s});else if("order"===b)o({type:"ORDER_SET",order:m});else if("signal"===b){var O="initiate"===v,p=!Object.keys(a).includes(u),j=p?new f.a({initiator:O,stream:n}):a[u];if(p&&(j.on("signal",(function(e){E(r,{type:"signal",forId:u,fromId:s,signal:e})})),j.on("stream",(function(e){o({type:"STREAMS_ADD",id:u,stream:e})}))),O||j.signal(v),p)return Object(d.a)({},e,{peers:Object(d.a)({},a,Object(l.a)({},u,j))})}return e}(e,t);case"SERVER_SET":return Object(d.a)({},e,{server:t.server});case"STREAMS_ADD":return Object(d.a)({},e,{streams:Object(d.a)({},c,Object(l.a)({},t.id,t.stream))});case"VIDEO_ELEMENT_SET":return Object(d.a)({},e,{videoElements:Object(l.a)({},t.id,t.videoElement)});default:return console.error("Unknown action:",t),e}}var O=Object(a.createContext)(v),p=function(e){var t=e.children,n=Object(a.useReducer)(b,v),c=Object(u.a)(n,2),o=c[0],i=c[1];return r.a.createElement(O.Provider,{value:[o,i]},t)},j=n(17),S=n(90),g=n(91),y=n(18),h=n.n(y),w=n(24),R=function(){var e=Object(a.useContext)(O),t=Object(u.a)(e,2),n=t[0],c=t[1],o=n.myStream,i=n.videoElements,s=Object(a.useState)([]),m=Object(u.a)(s,2),f=m[0],v=m[1],E=Object(a.useState)(!1),b=Object(u.a)(E,2),p=b[0],S=b[1],g=Object(a.useState)(null),y=Object(u.a)(g,2),R=y[0],k=y[1],I=Object(a.useState)(null),T=Object(u.a)(I,2),_=T[0],x=T[1],D=Object(a.useState)(null),C=Object(u.a)(D,2),M=C[0],A=C[1],L=function(){var e=Object(w.a)(h.a.mark((function e(){var t,n,a;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o&&o.getTracks().forEach((function(e){return e.stop()})),e.next=3,navigator.mediaDevices.getUserMedia({audio:{autoGainControl:{exact:!1},deviceId:R&&{exact:R},echoCancellation:!1,noiseSuppression:{exact:!1}},video:{deviceId:M&&{exact:M}}});case 3:t=e.sent,n=window.AudioContext||window.webkitAudioContext,a=new n,a.createMediaStreamSource(t).connect(a.destination),c({type:"MY_STREAM_SET",stream:t});case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();Object(a.useEffect)((function(){o&&p&&function(){var e=Object(w.a)(h.a.mark((function e(){var t;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,v(t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()()}),[o,p]),Object(a.useEffect)((function(){L()}),[R,M]),Object(a.useEffect)((function(){var e=Object.values(i);e.length&&_&&e.setSinkId(_)}),[_,i]);var N=["audioinput","audiooutput","videoinput"],V=["Audio Input","Audio Output","Video Input"],U=[[R,k],[_,x],[M,A]],Y=f.reduce((function(e,t){var n=t.deviceId,a=t.kind,r=N.indexOf(a);return[].concat(Object(j.a)(e.slice(0,r)),[Object(d.a)({},e[r],Object(l.a)({},n,t))],Object(j.a)(e.slice(r+1)))}),[{},{},{}]);return p?r.a.createElement(r.a.Fragment,null,Y.map((function(e,t){var n=Object.values(e);if(0===n.length)return null;var a=V[t],c=Object(u.a)(U[t],2),o=c[0],i=c[1];return r.a.createElement("label",{key:a},a,r.a.createElement("select",{onChange:function(e){return i(e.target.value)},value:o||"default"},n.map((function(e){var t=e.deviceId,n=e.label;return r.a.createElement("option",{key:t,value:t},n)}))))})),r.a.createElement("button",{onClick:function(){return S(!1)}},"x")):r.a.createElement("button",{onClick:function(){return S(!0)}},"Audio/Video settings")},k=function(){var e=Object(a.useState)(!0),t=Object(u.a)(e,2),n=t[0],c=t[1],o=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",null,"Welcome. Let's make the connections."),r.a.createElement("div",null,"First, enable your audio and video. Before you click the button, put on headphones so there's no feedback!"),r.a.createElement("button",{onClick:function(){return c(!1)}},"Let's go!")),i=Object(d.a)({alignItems:"center",display:"flex",flexDirection:n?"column":"row"},n?{}:{bottom:0,justifyContent:"space-between",position:"absolute"});return r.a.createElement("section",{style:i},n?o:r.a.createElement(R,null))},I=function(e){var t=e.id,n=e.isMe,c=e.numColumns,o=e.stream,i=Object(a.useContext)(O),s=Object(u.a)(i,2),l=s[0],d=s[1],m=l.order,f=Object(a.useCallback)((function(e){e&&("srcObject"in e?e.srcObject=o:e.src=URL.createObjectURL(o),n&&d({type:"VIDEO_ELEMENT_SET",id:t,videoElement:e}))}),[o]),v=Object(a.useRef)(null),E=Object(S.a)({item:{id:t,type:"participant"},collect:function(e){return{isDragging:e.isDragging()}}}),b=Object(u.a)(E,2),p=b[0].isDragging,y=b[1],h=Object(g.a)({accept:"participant",drop:function(e){d({type:"ORDER_SEND"})},hover:function(e){var n=e.id;if(n!==t){var a=m.indexOf(t),r=m.indexOf(n),c=Object(j.a)(m);c[a]=n,c[r]=t,d({type:"ORDER_SET",order:c})}}}),w=Object(u.a)(h,2)[1];y(v),w(v);var R=m.findIndex((function(e){return t===e}))+1,I=Math.ceil(R/c),T={gridColumn:"".concat(R-(I-1)*c," / span 1"),gridRow:"".concat(I," / span 1"),opacity:p?.5:1,position:"relative"};return r.a.createElement("div",{ref:v,style:T},o&&r.a.createElement("video",{autoPlay:!0,muted:n,ref:f}),n&&r.a.createElement(k,null),o&&r.a.createElement("span",{style:{left:0,position:"absolute",top:0}},R))};var T=function(){var e=Object(a.useContext)(O),t=Object(u.a)(e,2),n=t[0],c=t[1];console.log("STATE",n);var o=n.myId,i=n.myStream,s=n.order,l=n.streams,d=function(e){var t=Object(a.useRef)();return Object(a.useEffect)((function(){t.current=e}),[e]),t.current}(i),m=new URLSearchParams(window.location.search).get("server");if(Object(a.useEffect)((function(){if(i&&!d&&m){var e=new WebSocket(m);e.addEventListener("close",(function(){return console.log("closing socket")})),e.addEventListener("error",(function(){return console.log("socket error")})),e.addEventListener("open",(function(){return console.log("opening socket")})),e.addEventListener("message",(function(e){var t=e.data;c({type:"SERVER_MESSAGE",data:t,dispatch:c})})),c({type:"SERVER_SET",server:e})}}),[i,d,m]),!m)return"You have to have a server. Sorry, that's just the way it is.";var f=s.length||1,v=Math.ceil(Math.sqrt(f)),E=Math.ceil(f/v),b=100/v,p=100/E,j={display:"grid",gridTemplateColumns:"repeat(".concat(v,", ").concat(b,"%)"),gridTemplateRows:"repeat(".concat(v,", ").concat(p,"%)"),height:"100%"};return r.a.createElement("main",{className:"videos",style:j},r.a.createElement(I,{isMe:!0,id:o,numColumns:v,stream:i}),Object.entries(l).map((function(e){var t=Object(u.a)(e,2),n=t[0],a=t[1];return r.a.createElement(I,{key:n,id:n,numColumns:v,stream:a})})))},_=(n(86),function(){return r.a.createElement(p,null,r.a.createElement(i.a,{backend:s.a},r.a.createElement(T,null)))});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(r.a.createElement(_,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[44,1,2]]]);
//# sourceMappingURL=main.a277a6c8.chunk.js.map