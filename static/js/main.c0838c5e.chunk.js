(this["webpackJsonpcascade-client"]=this["webpackJsonpcascade-client"]||[]).push([[0],{44:function(e,t,n){e.exports=n(87)},49:function(e,t,n){},74:function(e,t){},76:function(e,t){},86:function(e,t,n){},87:function(e,t,n){"use strict";n.r(t);var r,a,c,o=n(0),i=n.n(o),u=n(38),s=n.n(u),l=(n(49),n(89)),d=n(41),f=n(2),m=n(6),v=n(5),O=n(3),E=n(39),b=n.n(E);function p(e,t){(r=new MediaRecorder(e,{mimeType:"video/webm"})).addEventListener("dataavailable",(function(e){var t=e.data,n=P().server;console.log("SENDING VIDEO FILE TO SERVER"),n.send(t),a.stop()}))}function S(){if(!c){var e=window.AudioContext||window.webkitAudioContext;c=new e}return c}var j=-1;function g(e,t){console.log("LISTENING TO BLIPS");var n,c=S().createMediaStreamDestination();e.connect(c),n=c.stream,(a=new MediaRecorder(n,{mimeType:"audio/webm"})).addEventListener("dataavailable",(function(e){var t=e.data,n=P().server;console.log("SENDING METRONOME AUDIO TO SERVER"),n.send(t)}));var o=P(),i=o.myId,u=o.order,s=o.peers,l=u[u.length-1]===i,d=S().createAnalyser();d.fftSize=512,e.connect(d),e.connect(S().destination);var f=S().sampleRate/d.fftSize,m=Math.floor(1/f*1e3),v=new Uint8Array(d.frequencyBinCount),O=Math.floor(440/f),E=Math.floor(1760/f),b=!0,p=!1,j=setInterval((function(){var n=P(),c=n.countdown,o=n.mode;d.getByteFrequencyData(v);var i=v.reduce((function(e,t,n){var r=v[e]||0;return t>0&&t>r?n:e}),-1);if(-1===i&&p&&(p=!1),-1!==i&&!p){if(p=!0,b&&l){b=!1;var f=u[0];s[f].send(JSON.stringify({type:"SEND_RECORD_SIGNAL"}))}var m=Math.abs(O-i);Math.abs(E-i)<m?(console.log("HEARD HIGH BLIP NEAR ".concat(1760,"Hz")),o===R&&(c===U.countdown&&(r.start(),a.start()),1===c?(k(A,t),t({type:"COUNTDOWN_SET",countdown:U.countdown}),clearInterval(j),e.disconnect(d)):t({type:"COUNTDOWN_SET",countdown:c-1}))):console.log("HEARD LOW BLIP NEAR ".concat(440,"Hz"))}}),m)}function y(e){P().server.send(JSON.stringify(e))}function h(e,t){var n=new WebSocket(e);n.addEventListener("open",(function(){return console.log("opening socket")})),n.addEventListener("close",(function(){return console.log("closing socket")})),n.addEventListener("error",(function(){return console.log("socket error")})),n.addEventListener("message",(function(e){var n=e.data,r=JSON.parse(n);switch(console.log("ACTION (from server):",r),r.type){case"MODE_SET":k(r.mode,t);break;case"ORDER_SET":!function(e,t){var n=e.order,r=P(),a=r.myId,c=r.order,o=r.peers,i=r.streams;t(e),0===c.length&&n.forEach((function(e){e===a||o[e]||I(!0,e,t)}));c.reduce((function(e,t){return n.includes(t)?e:e.concat(t)}),[]).forEach((function(e){C(i[e]),o[e].destroy()}))}(r,t);break;case"PEER_SIGNAL":!function(e,t){var n=P().peers,r=e.fromId,a=e.signal;(n[r]||I(!1,r,t)).signal(a)}(r,t);break;case"pong":break;default:t(r)}})),setInterval((function(){y({type:"ping"})}),3e4),t({type:"SERVER_SET",server:n})}function I(e,t,n){var r=P(),a=r.myId,c=r.myStream,o=c.clone(),i=new b.a({initiator:e,stream:o});return i._sendStreams=[o],i.on("signal",(function(e){y({type:"PEER_SIGNAL",forId:t,fromId:a,signal:e})})),i.on("stream",(function(e){var r=P().mode;r===R?function(e,t){console.log("RECEIVING CASCADED STREAM");var n=P(),r=n.myId,a=n.order,c=n.streams,o=_();if(L){var i=x().slice(0,-1).reverse().find((function(e){return!c[e]}));t({type:"STREAMS_ADD",id:i,stream:e}),o&&w(o,e)}else{L=!0,function(e,t){g(S().createMediaStreamSource(e),t)}(e,t);var u=a.indexOf(r),s=a[u-1],l=c[s];o&&(w(o,e),w(o,l.clone()))}}(e,n):(n({type:"STREAMS_ADD",id:t,stream:e}),r===N&&0===i._sendStreams.length&&w(i,c.clone()))})),i.on("data",(function(e){var t=JSON.parse(e.toString()),r=t.mode,a=t.type;"MODE_SET"===a?k(r,n):"SEND_RECORD_SIGNAL"===a?(console.log("SENDING RECORD SIGNAL"),j=0):console.error('Unknown action "'.concat(a,'" sent thru peer'))})),n({type:"PEERS_ADD",id:t,peer:i}),i}function w(e,t){e.addStream(t),e._sendStreams.push(t)}function T(e){var t=e._sendStreams.pop();return C(t),e.removeStream(t),t}var D=1,R=2,A=3,N=4;function _(){var e=P(),t=e.myId,n=e.order,r=e.peers,a=n.indexOf(t)+1;return r[n[a]]}function C(e){e.getTracks().forEach((function(e){return e.stop()}))}function k(e,t){switch(t({type:"MODE_SET",mode:e}),e){case R:!function(){var e=P().peers;[].concat(Object(v.a)(x()),Object(v.a)(function(){var e=P(),t=e.myId,n=e.order,r=n.indexOf(t);return n.slice(r+1)}().slice(1))).forEach((function(t){T(e[t])}))}();break;case N:!function(e){var t=_();t&&t.send(JSON.stringify({type:"MODE_SET",mode:e}))}(N),function(){var e=P(),t=e.myStream,n=e.peers;L=!1;var r=_();if(r)for(;r._sendStreams.length>1;)T(r);x().forEach((function(e){w(n[e],t.clone())}))}(),r.stop()}}function M(e){var t=P().myId,n=R;y({type:"MODE_SET",fromId:t,mode:n}),k(n,e),function(e){console.log("SENDING BLIPS");var t=S().createMediaStreamDestination(),n=t.stream;w(_(),n);var r=S().createOscillator();r.frequency.value=440;var a=S().createGain();a.gain.value=0,r.connect(a),g(a,e),a.connect(t),r.start();var c=window.setInterval((function(){if(P().mode===N)return r.stop(),window.clearInterval(c),void(j=-1);-1!==j&&(j%4===0&&(r.frequency.setValueAtTime(1760,S().currentTime),r.frequency.setValueAtTime(440,S().currentTime+.1)),j+=1),a.gain.setValueAtTime(.1,S().currentTime),a.gain.setValueAtTime(0,S().currentTime+.1)}),600)}(e)}function x(){var e=P(),t=e.myId,n=e.order,r=n.indexOf(t);return n.slice(0,r)}var L=!1;var U={audioOutput:null,countdown:4,files:[],iAmInitiator:!1,mode:0,myId:null,myStream:null,order:[],peers:{},server:null,streams:{}};var G={};function P(){return G}function V(e,t){var n=function(e,t){console.log("ACTION",t);var n=e.files,r=e.mode,a=e.myId,c=e.myStream,o=e.order,i=e.peers,u=e.streams;switch(t.type){case"AUDIO_OUTPUT_SET":return Object(O.a)({},e,{audioOutput:t.deviceId});case"COUNTDOWN_SET":return Object(O.a)({},e,{countdown:t.countdown});case"FILES_ADD":return Object(O.a)({},e,{files:[].concat(Object(v.a)(n),[[t.fileName,t.blobURL]])});case"MODE_SET":var s=t.mode,l=o.indexOf(a),d=o[l-1],E=d?Object(m.a)({},d,u[d]):{},b=s===R||s===N?E:u;return Object(O.a)({},e,{mode:s,streams:b});case"MY_ID_SET":return Object(O.a)({},e,{myId:t.id});case"MY_STREAM_SET":var p=c?r:D;return Object(O.a)({},e,{mode:p,myStream:t.stream});case"ORDER_SET":var S=t.order,j=0===S.findIndex((function(e){return a===e})),g=S.reduce((function(e,t){return t===a?e:[Object(O.a)({},e[0],Object(m.a)({},t,i[t])),Object(O.a)({},e[1],Object(m.a)({},t,u[t]))]}),[{},{}]),y=Object(f.a)(g,2),h=y[0],I=y[1];return Object(O.a)({},e,{iAmInitiator:j,order:S,peers:h,streams:I});case"PEERS_ADD":return Object(O.a)({},e,{peers:Object(O.a)({},i,Object(m.a)({},t.id,t.peer))});case"SERVER_SET":return Object(O.a)({},e,{server:t.server});case"STREAMS_ADD":return Object(O.a)({},e,{streams:Object(O.a)({},u,Object(m.a)({},t.id,t.stream))});default:return console.error("Unknown action:",t),e}}(e,t);return G=n,n}var B=Object(o.createContext)(U),W=function(e){var t=e.children,n=Object(o.useReducer)(V,U),r=Object(f.a)(n,2),a=r[0],c=r[1];return i.a.createElement(B.Provider,{value:[a,c]},t)},J=function(){var e=Object(o.useContext)(B),t=Object(f.a)(e,1)[0].files;return i.a.createElement("aside",null,t.map((function(e,t){var n=Object(f.a)(e,2),r=n[0],a=n[1];return i.a.createElement("a",{key:a,download:r,href:a},"Download your video for cascade ",t+1)})))},F=function(){var e=Object(o.useContext)(B),t=Object(f.a)(e,2),n=t[0],r=t[1],a=n.iAmInitiator,c=n.mode,u=n.myId,s=n.order,l=u===s[s.length-1];return i.a.createElement("nav",null,[D,N].includes(c)&&a&&s.length>1&&i.a.createElement("button",{className:"big-button",onClick:function(){return M(r)}},"GO"),c===A&&l&&i.a.createElement("button",{className:"big-button",onClick:function(){return function(e){var t=P(),n=t.order;t.peers[n[0]].send(JSON.stringify({type:"MODE_SET",mode:N}))}()}},"STOP"))},H=n(90),q=n(91),z=n(18),Y=n.n(z),$=n(24),K=function(e){var t=e.style,n=Object(o.useContext)(B),r=Object(f.a)(n,2),a=r[0],c=r[1],u=a.audioOutput,s=a.myStream,l=a.peers,d=Object(o.useState)([]),E=Object(f.a)(d,2),b=E[0],S=E[1],j=Object(o.useState)(!1),g=Object(f.a)(j,2),y=g[0],h=g[1],I=Object(o.useState)(null),D=Object(f.a)(I,2),R=D[0],A=D[1],N=Object(o.useState)(null),_=Object(f.a)(N,2),C=_[0],k=_[1];Object(o.useEffect)((function(){s&&y&&function(){var e=Object($.a)(Y.a.mark((function e(){var t;return Y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,S(t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()()}),[s,y]),Object(o.useEffect)((function(){(function(){var e=Object($.a)(Y.a.mark((function e(){var t;return Y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.getUserMedia({audio:{deviceId:R&&{exact:R},autoGainControl:{exact:!1},echoCancellation:!1,noiseSuppression:{exact:!1}},video:{deviceId:C&&{exact:C}}});case 2:p(t=e.sent),s&&Object.values(l).forEach((function(e){T(e),w(e,t)})),c({type:"MY_STREAM_SET",stream:t});case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}})()()}),[R,C]);var M=["audioinput","audiooutput","videoinput"],x=["Audio Input","Audio Output","Video Input"],L=[[R,A],[u,function(e){c({type:"AUDIO_OUTPUT_SET",deviceId:e})}],[C,k]],U=b.reduce((function(e,t){var n=t.deviceId,r=t.kind,a=M.indexOf(r);return[].concat(Object(v.a)(e.slice(0,a)),[Object(O.a)({},e[a],Object(m.a)({},n,t))],Object(v.a)(e.slice(a+1)))}),[{},{},{}]);return i.a.createElement("section",{className:"av-setup",style:t},y?i.a.createElement(i.a.Fragment,null,U.map((function(e,t){var n=Object.values(e);if(0===n.length)return null;var r=x[t],a=Object(f.a)(L[t],2),c=a[0],o=a[1];return i.a.createElement("label",{key:r},r,i.a.createElement("select",{onChange:function(e){return o(e.target.value)},value:c||"default"},n.map((function(e){var t=e.deviceId,n=e.label;return i.a.createElement("option",{key:t,value:t},n)}))))})),i.a.createElement("button",{onClick:function(){return h(!1)}},"x")):i.a.createElement("button",{onClick:function(){return h(!0)}},"Audio/Video settings"))},Q=function(){var e=Object(o.useContext)(B),t=Object(f.a)(e,1)[0].countdown;return i.a.createElement("span",{className:"countdown"},t)};function X(e){var t=Object(o.useRef)();return Object(o.useEffect)((function(){t.current=e}),[e]),t.current}var Z=function(e){e.id,e.isMe;var t=e.setVideoAspectRatio,n=e.stream,r=Object(o.useContext)(B),a=Object(f.a)(r,1)[0].audioOutput,c=X(n),u=X(a),s=Object(o.useCallback)((function(e){e&&(n!==c&&(e.addEventListener("loadedmetadata",(function(e){var n=e.target;t(n.videoWidth/n.videoHeight)})),"srcObject"in e?e.srcObject=n:e.src=URL.createObjectURL(n)),a&&a!==u&&e.setSinkId(a))}),[a,n]);return n?i.a.createElement("video",{autoPlay:!0,ref:s}):null},ee=function(e){var t=e.col,n=e.id,r=e.isMe,a=(e.numColumns,e.orderNumber),c=e.row,u=e.stream,s=Object(o.useContext)(B),l=Object(f.a)(s,2),d=l[0],m=l[1],O=d.iAmInitiator,E=d.mode,b=d.myId,p=d.order,S=Object(o.useRef)(null),j=Object(H.a)({item:{id:n,type:"participant"},canDrag:function(){return O&&[D,N].includes(E)},collect:function(e){return{isDragging:e.isDragging()}}}),g=Object(f.a)(j,2),h=g[0].isDragging,I=g[1],w=Object(q.a)({accept:"participant",drop:function(e){y({type:"ORDER_SET",fromId:b,order:p})},hover:function(e){var t=e.id;if(t!==n){var r=p.indexOf(n),a=p.indexOf(t),c=Object(v.a)(p);c[r]=t,c[a]=n,m({type:"ORDER_SET",order:c})}}}),T=Object(f.a)(w,2)[1];I(S),T(S);var _={gridColumn:"".concat(t," / span 1"),gridRow:"".concat(c," / span 1"),opacity:h?.5:1},C=Object(o.useState)(null),k=Object(f.a)(C,2),M=k[0],x=k[1],L=Object(o.useState)(0),U=Object(f.a)(L,2),G=U[0],P=U[1],V=Object(o.useState)(0),W=Object(f.a)(V,2),J=W[0],F=W[1];Object(o.useEffect)((function(){var e=S.current;if(e&&M){var t=new ResizeObserver((function(e){e.forEach((function(e){var t=e.contentRect,n=t.width,r=t.height,a=r,c=a*M;c>n&&(a=(c=n)/M),P((n-c)/2),F((r-a)/2)}))}));return t.observe(e),function(){t.disconnect()}}}),[M]);var z=a>0&&M&&S.current,Y={backgroundColor:(E===R?"yellow":E===A&&"red")||"green",left:"calc(".concat(G,"px + 1%)"),top:"calc(".concat(J,"px + 1%)")},$={right:Y.left,top:Y.top};return i.a.createElement("div",{ref:S,className:"video-draggable",style:_},i.a.createElement(Z,{id:n,isMe:r,setVideoAspectRatio:x,stream:u}),r&&i.a.createElement(K,{style:$}),z&&i.a.createElement("span",{className:"order-number",style:Y},a),E===R&&r&&i.a.createElement(Q,null))},te=function(){var e=Object(o.useContext)(B),t=Object(f.a)(e,1)[0],n=t.myId,r=t.myStream,a=t.order,c=t.streams,u=Object.values(c).length+1,s=Math.ceil(Math.sqrt(u)),l=Math.ceil(u/s),d=100/s,m=100/l,v={gridTemplateColumns:"repeat(".concat(s,", ").concat(d,"%)"),gridTemplateRows:"repeat(".concat(s,", ").concat(m,"%)")},O=function(e){var t=a.indexOf(e)+1,n=Math.ceil(t/s);return{col:t-(n-1)*s,orderNumber:t,row:n}};return i.a.createElement("main",{className:"video-grid",style:v},i.a.createElement(ee,Object.assign({id:n,isMe:!0,stream:r},O(n))),Object.entries(c).map((function(e){var t=Object(f.a)(e,2),n=t[0],r=t[1];return i.a.createElement(ee,Object.assign({key:n,id:n,stream:r},O(n)))})))},ne=function(e){var t=e.onClick;return i.a.createElement(i.a.Fragment,null,i.a.createElement("div",null,"Welcome. Let's make the connections."),i.a.createElement("div",null,"First, enable your audio and video. Before you click the button, put on headphones so there's no feedback!"),i.a.createElement("button",{onClick:t},"Let's go!"))},re=function(){var e=Object(o.useContext)(B),t=Object(f.a)(e,1)[0];console.log("STATE",t);var n=Object(o.useState)(!0),r=Object(f.a)(n,2),a=r[0],c=r[1];return a?i.a.createElement(ne,{onClick:function(){return c(!1)}}):i.a.createElement(i.a.Fragment,null,i.a.createElement(te,null),i.a.createElement(F,null),i.a.createElement(J,null))},ae=function(e){var t=e.children,n=Object(o.useContext)(B),r=Object(f.a)(n,2),a=r[0],c=r[1],i=a.myStream,u=X(i),s=new URLSearchParams(window.location.search).get("server");return Object(o.useEffect)((function(){i&&!u&&s&&h(s,c)}),[i,u,s]),s?t:"You have to have a server. Sorry, that's just the way it is."},ce=(n(86),function(){return i.a.createElement(W,null,i.a.createElement(ae,null,i.a.createElement(l.a,{backend:d.a},i.a.createElement(re,null))))});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(i.a.createElement(ce,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[44,1,2]]]);
//# sourceMappingURL=main.c0838c5e.chunk.js.map