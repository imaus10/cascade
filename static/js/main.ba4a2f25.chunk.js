(this["webpackJsonpcascade-client"]=this["webpackJsonpcascade-client"]||[]).push([[0],{29:function(e,t,n){e.exports=n(72)},34:function(e,t,n){},60:function(e,t){},62:function(e,t){},70:function(e,t,n){},71:function(e,t,n){},72:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),c=n(27),o=n.n(c),i=(n(34),n(1)),s=n(4),u=n(2),l=n(15),m=n(11),d=n.n(m),f=n(14),v=n(28),E=n.n(v),b={myStream:null,peers:{},signalServer:null,streams:{},videoElement:null};function O(e,t){console.log("ACTION",t);var n=e.streams;switch(t.type){case"MY_STREAM_SET":return function(e,t){var n=e.myStream,a=e.peers,r=t.stream;Object.values(a).forEach((function(e){e.removeStream(n),e.addStream(r)}))}(e,t),Object(u.a)({},e,{myStream:t.stream});case"PEER_SIGNAL":return function(e,t){var n=e.myStream,a=e.peers,r=e.signalServer,c=t.data,o=t.dispatch,i=JSON.parse(c),l=i.forId,m=i.fromId,d=i.signal,f="initiate"===d,v=!Object.keys(a).includes(m),b=v?new E.a({initiator:f,stream:n}):a[m];return v&&(console.log("making new peer ".concat(m," (initiator = ").concat(f,")")),b.on("signal",(function(e){console.log("sending signal to ".concat(m),e),r.send(JSON.stringify({forId:m,fromId:l,signal:e}))})),b.on("stream",(function(e){o({type:"STREAMS_ADD",id:m,stream:e})}))),f||(console.log("receiving signal from ".concat(m)),b.signal(d)),v?Object(u.a)({},e,{peers:Object(u.a)({},a,Object(s.a)({},m,b))}):e}(e,t);case"SIGNAL_SERVER_SET":return Object(u.a)({},e,{signalServer:t.signalServer});case"STREAMS_ADD":return Object(u.a)({},e,{streams:Object(u.a)({},n,Object(s.a)({},t.id,t.stream))});case"VIDEO_ELEMENT_SET":return Object(u.a)({},e,{videoElement:t.videoElement});default:return console.error("Unknown action:",t),e}}var j=Object(a.createContext)(b),g=function(e){var t=e.children,n=Object(a.useReducer)(O,b),c=Object(i.a)(n,2),o=c[0],s=c[1];return r.a.createElement(j.Provider,{value:[o,s]},t)},p=function(){var e=Object(a.useContext)(j),t=Object(i.a)(e,2),n=t[0],c=t[1],o=n.myStream,m=n.videoElement,v=Object(a.useState)([]),E=Object(i.a)(v,2),b=E[0],O=E[1],g=Object(a.useState)(!0),p=Object(i.a)(g,2),S=p[0],h=p[1],y=Object(a.useState)(null),k=Object(i.a)(y,2),w=k[0],I=k[1],T=Object(a.useState)(null),_=Object(i.a)(T,2),x=_[0],A=_[1],L=Object(a.useState)(null),R=Object(i.a)(L,2),N=R[0],C=R[1],D=function(){var e=Object(f.a)(d.a.mark((function e(){var t;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o&&o.getTracks().forEach((function(e){return e.stop()})),e.next=3,navigator.mediaDevices.getUserMedia({audio:{deviceId:w&&{exact:w}},video:{deviceId:N&&{exact:N}}});case 3:t=e.sent,c({type:"MY_STREAM_SET",stream:t});case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();Object(a.useEffect)((function(){(function(){var e=Object(f.a)(d.a.mark((function e(){var t;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,O(t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}})()()}),[]),Object(a.useEffect)((function(){D()}),[w,N]),Object(a.useEffect)((function(){m&&x&&m.setSinkId(x)}),[x,m]);var M=["audioinput","audiooutput","videoinput"],V=["Audio Input","Audio Output","Video Input"],P=[[w,I],[x,A],[N,C]],U=b.reduce((function(e,t){var n=t.deviceId,a=t.kind,r=M.indexOf(a);return[].concat(Object(l.a)(e.slice(0,r)),[Object(u.a)({},e[r],Object(s.a)({},n,t))],Object(l.a)(e.slice(r+1)))}),[{},{},{}]);return r.a.createElement("div",{className:"io-settings"},S?r.a.createElement(r.a.Fragment,null,U.map((function(e,t){var n=V[t],a=Object(i.a)(P[t],2),c=a[0],o=a[1];return r.a.createElement("label",{key:n},n,r.a.createElement("select",{onChange:function(e){return o(e.target.value)},value:c||"default"},Object.values(e).map((function(e){var t=e.deviceId,n=e.label;return r.a.createElement("option",{key:t,value:t},n)}))))})),r.a.createElement("button",{onClick:function(){return h(!1)}},"x")):r.a.createElement("button",{onClick:function(){return h(!0)}},"Audio/Video settings"))},S=function(){var e=Object(a.useState)(!0),t=Object(i.a)(e,2),n=t[0],c=t[1],o=r.a.createElement(r.a.Fragment,null,r.a.createElement("div",null,"Welcome. Let's make the connections."),r.a.createElement("div",null,"First, enable your audio and video. Before you click the button, put on headphones so there's no feedback!"),r.a.createElement("button",{onClick:function(){return c(!1)}},"Let's go!")),s={alignItems:"center",display:"flex",flexDirection:n?"column":"row"};return r.a.createElement("section",{style:s},n?o:r.a.createElement(p,null))},h=function(e){var t=e.stream,n=Object(a.useContext)(j),c=Object(i.a)(n,2)[1],o=Object(a.useCallback)((function(e){e&&("srcObject"in e?e.srcObject=t:e.src=URL.createObjectURL(t),c({type:"VIDEO_ELEMENT_SET",videoElement:e}))}),[t]);return t&&r.a.createElement("video",{autoPlay:!0,ref:o})};n(70);var y=function(){var e=Object(a.useContext)(j),t=Object(i.a)(e,2),n=t[0],c=t[1];console.log("STATE",n);var o=n.myStream,s=n.streams,u=function(e){var t=Object(a.useRef)();return Object(a.useEffect)((function(){t.current=e}),[e]),t.current}(o),l=new URLSearchParams(window.location.search).get("signalServer");return Object(a.useEffect)((function(){if(o&&!u&&l){var e=new WebSocket(l);e.addEventListener("close",(function(){return console.log("closing socket")})),e.addEventListener("error",(function(){return console.log("socket error")})),e.addEventListener("open",(function(){return console.log("opening socket")})),e.addEventListener("message",(function(e){var t=e.data;console.log("message from server:",t),c({type:"PEER_SIGNAL",data:t,dispatch:c})})),c({type:"SIGNAL_SERVER_SET",signalServer:e})}}),[o,u,l]),l?r.a.createElement("div",{className:"videos"},r.a.createElement("div",{className:"my-stream"},o&&r.a.createElement(h,{stream:o}),r.a.createElement(S,null)),Object.entries(s).map((function(e){var t=Object(i.a)(e,2),n=t[0],a=t[1];return r.a.createElement(h,{key:n,stream:a})}))):"You have to have a server. Sorry, that's just the way it is."},k=(n(71),function(){return r.a.createElement(g,null,r.a.createElement(y,null))});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(r.a.createElement(k,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[29,1,2]]]);
//# sourceMappingURL=main.ba4a2f25.chunk.js.map