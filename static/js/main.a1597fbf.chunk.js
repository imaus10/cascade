(this["webpackJsonpcascade-client"]=this["webpackJsonpcascade-client"]||[]).push([[0],{44:function(e,t,n){e.exports=n(87)},49:function(e,t,n){},74:function(e,t){},76:function(e,t){},86:function(e,t,n){},87:function(e,t,n){"use strict";n.r(t);var r,a,c,o,i,u=n(0),s=n.n(u),l=n(38),d=n.n(l),f=(n(49),n(89)),m=n(41),v=n(2),O=n(6),E=n(5),b=n(3),p=n(39),S=n.n(p),j=n(7),g=n.n(j),y=n(14);function h(e){z().server.send(JSON.stringify(e))}function I(e,t){var n=new WebSocket(e);n.addEventListener("open",(function(){return console.log("opening socket")})),n.addEventListener("close",(function(){return console.log("closing socket")})),n.addEventListener("error",(function(){return console.log("socket error")})),n.addEventListener("message",(function(e){var n=e.data,r=JSON.parse(n);switch(console.log("ACTION (from server):",r),r.type){case"MODE_SET":B(r.mode,t);break;case"ORDER_SET":!function(e,t){var n=e.order,r=z(),a=r.myId,c=r.order,o=r.peers,i=r.streams;t(e),0===c.length&&n.forEach((function(e){e===a||o[e]||k(!0,e,t)}));c.reduce((function(e,t){return n.includes(t)?e:e.concat(t)}),[]).forEach((function(e){V(i[e]),o[e].destroy()}))}(r,t);break;case"PEER_SIGNAL":!function(e,t){var n=z().peers,r=e.fromId,a=e.signal;(n[r]||k(!1,r,t)).signal(a)}(r,t);break;case"pong":break;default:t(r)}})),setInterval((function(){h({type:"ping"})}),3e4),t({type:"SERVER_SET",server:n})}var w,T=[];function D(e,t){(r=new MediaRecorder(e,{mimeType:"video/webm"})).addEventListener("dataavailable",(function(e){var t=e.data,n=z().server;console.log("SENDING VIDEO FILE TO SERVER"),n.send(t),c.stop()})),r.addEventListener("start",Object(y.a)(g.a.mark((function e(){return g.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=Date.now()-i;case 1:case"end":return e.stop()}}),e)}))))}function R(e){(c=new MediaRecorder(e,{mimeType:"audio/webm"})).addEventListener("dataavailable",(function(e){var t=e.data,n=z().server;console.log("SENDING METRONOME AUDIO TO SERVER"),n.send(t),h({type:"sync_info",fromId:z().myId,blipTimes:T,blipRecordStartTime:o,recordStartTime:a})})),c.addEventListener("start",Object(y.a)(g.a.mark((function e(){return g.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=Date.now()-i;case 1:case"end":return e.stop()}}),e)}))))}function A(){if(!w){var e=window.AudioContext||window.webkitAudioContext;w=new e}return w}var N=-1;function _(e,t){console.log("LISTENING TO BLIPS");var n=A().createMediaStreamDestination();e.connect(n),R(n.stream);var a=z(),o=a.myId,u=a.order,s=a.peers,l=u[u.length-1]===o,d=A().createAnalyser();d.fftSize=512,e.connect(d),d.connect(A().destination);var f=A().sampleRate/d.fftSize,m=Math.floor(1/f*1e3),v=new Uint8Array(d.frequencyBinCount),O=Math.floor(440/f),E=Math.floor(1760/f),b=!0,p=!1,S=!1,j=setInterval((function(){var n=z(),a=n.countdown,o=n.mode;if(o===G)return clearInterval(j),void e.disconnect(d);d.getByteFrequencyData(v);var f=v.reduce((function(e,t,n){var r=v[e]||0;return t>0&&t>r?n:e}),-1);if(-1===f&&S&&(S=!1),-1!==f&&!S){if(S=!0,p&&T.push(Date.now()-i),b&&l){b=!1;var m=u[0];s[m].send(JSON.stringify({type:"SEND_RECORD_SIGNAL"}))}var g=Math.abs(O-f);Math.abs(E-f)<g?(console.log("HEARD HIGH BLIP NEAR ".concat(1760,"Hz")),o===L&&(a===H.countdown&&(r.start(),c.start(),p=!0,i=Date.now()),1===a?(B(U,t),t({type:"COUNTDOWN_SET",countdown:H.countdown})):t({type:"COUNTDOWN_SET",countdown:a-1}))):console.log("HEARD LOW BLIP NEAR ".concat(440,"Hz"))}}),m)}function k(e,t,n){var r=z(),a=r.myId,c=r.myStream,o=c.clone(),i=new S.a({initiator:e,stream:o});return i._sendStreams=[o],i.on("signal",(function(e){h({type:"PEER_SIGNAL",forId:t,fromId:a,signal:e})})),i.on("stream",(function(e){var r=z().mode;r===L?function(e,t){console.log("RECEIVING CASCADED STREAM");var n=z(),r=n.myId,a=n.order,c=n.streams,o=P();if(F){var i=J().slice(0,-1).reverse().find((function(e){return!c[e]}));t({type:"STREAMS_ADD",id:i,stream:e}),o&&C(o,e)}else{F=!0,function(e,t){_(A().createMediaStreamSource(e),t)}(e,t);var u=a.indexOf(r),s=a[u-1],l=c[s];o&&(C(o,e),C(o,l.clone()))}}(e,n):(n({type:"STREAMS_ADD",id:t,stream:e}),r===G&&0===i._sendStreams.length&&C(i,c.clone()))})),i.on("data",(function(e){var t=JSON.parse(e.toString()),r=t.mode,a=t.type;"MODE_SET"===a?B(r,n):"SEND_RECORD_SIGNAL"===a?(console.log("SENDING RECORD SIGNAL"),N=0):console.error('Unknown action "'.concat(a,'" sent thru peer'))})),n({type:"PEERS_ADD",id:t,peer:i}),i}function C(e,t){e.addStream(t),e._sendStreams.push(t)}function M(e){var t=e._sendStreams.pop();return V(t),e.removeStream(t),t}var x=1,L=2,U=3,G=4;function P(){var e=z(),t=e.myId,n=e.order,r=e.peers,a=n.indexOf(t)+1;return r[n[a]]}function V(e){e.getTracks().forEach((function(e){return e.stop()}))}function B(e,t){switch(t({type:"MODE_SET",mode:e}),e){case L:!function(){var e=z().peers;[].concat(Object(E.a)(J()),Object(E.a)(function(){var e=z(),t=e.myId,n=e.order,r=n.indexOf(t);return n.slice(r+1)}().slice(1))).forEach((function(t){M(e[t])}))}();break;case G:r.stop(),function(e){var t=P();t&&t.send(JSON.stringify({type:"MODE_SET",mode:e}))}(G),function(){var e=z(),t=e.myStream,n=e.peers;F=!1;var r=P();if(r)for(;r._sendStreams.length>1;)M(r);J().forEach((function(e){C(n[e],t.clone())}))}()}}function W(e){var t=z().myId,n=L;h({type:"MODE_SET",fromId:t,mode:n}),B(n,e),function(e){console.log("SENDING BLIPS");var t=A().createMediaStreamDestination(),n=t.stream;C(P(),n);var r=A().createOscillator();r.frequency.value=440;var a=A().createGain();a.gain.value=0,r.connect(a),_(a,e),a.connect(t),r.start();var c=window.setInterval((function(){if(z().mode===G)return r.stop(),window.clearInterval(c),void(N=-1);-1!==N&&(N%4===0&&(r.frequency.setValueAtTime(1760,A().currentTime),r.frequency.setValueAtTime(440,A().currentTime+.1)),N+=1),a.gain.setValueAtTime(.1,A().currentTime),a.gain.setValueAtTime(0,A().currentTime+.1)}),600)}(e)}function J(){var e=z(),t=e.myId,n=e.order,r=n.indexOf(t);return n.slice(0,r)}var F=!1;var H={audioOutput:null,countdown:4,files:[],iAmInitiator:!1,mode:0,myId:null,myStream:null,order:[],peers:{},server:null,streams:{}};var q={};function z(){return q}function Y(e,t){var n=function(e,t){console.log("ACTION",t);var n=e.files,r=e.mode,a=e.myId,c=e.myStream,o=e.order,i=e.peers,u=e.streams;switch(t.type){case"AUDIO_OUTPUT_SET":return Object(b.a)({},e,{audioOutput:t.deviceId});case"COUNTDOWN_SET":return Object(b.a)({},e,{countdown:t.countdown});case"FILES_ADD":return Object(b.a)({},e,{files:[].concat(Object(E.a)(n),[[t.fileName,t.blobURL]])});case"MODE_SET":var s=t.mode,l=o.indexOf(a),d=o[l-1],f=d?Object(O.a)({},d,u[d]):{},m=s===L||s===G?f:u;return Object(b.a)({},e,{mode:s,streams:m});case"MY_ID_SET":return Object(b.a)({},e,{myId:t.id});case"MY_STREAM_SET":var p=c?r:x;return Object(b.a)({},e,{mode:p,myStream:t.stream});case"ORDER_SET":var S=t.order,j=0===S.findIndex((function(e){return a===e})),g=S.reduce((function(e,t){return t===a?e:[Object(b.a)({},e[0],Object(O.a)({},t,i[t])),Object(b.a)({},e[1],Object(O.a)({},t,u[t]))]}),[{},{}]),y=Object(v.a)(g,2),h=y[0],I=y[1];return Object(b.a)({},e,{iAmInitiator:j,order:S,peers:h,streams:I});case"PEERS_ADD":return Object(b.a)({},e,{peers:Object(b.a)({},i,Object(O.a)({},t.id,t.peer))});case"SERVER_SET":return Object(b.a)({},e,{server:t.server});case"STREAMS_ADD":return Object(b.a)({},e,{streams:Object(b.a)({},u,Object(O.a)({},t.id,t.stream))});default:return console.error("Unknown action:",t),e}}(e,t);return q=n,n}var $=Object(u.createContext)(H),K=function(e){var t=e.children,n=Object(u.useReducer)(Y,H),r=Object(v.a)(n,2),a=r[0],c=r[1];return s.a.createElement($.Provider,{value:[a,c]},t)},Q=function(){var e=Object(u.useContext)($),t=Object(v.a)(e,1)[0].files;return s.a.createElement("aside",null,t.map((function(e,t){var n=Object(v.a)(e,2),r=n[0],a=n[1];return s.a.createElement("a",{key:a,download:r,href:a},"Download your video for cascade ",t+1)})))},X=function(){var e=Object(u.useContext)($),t=Object(v.a)(e,2),n=t[0],r=t[1],a=n.iAmInitiator,c=n.mode,o=n.myId,i=n.order,l=o===i[i.length-1];return s.a.createElement("nav",null,[x,G].includes(c)&&a&&i.length>1&&s.a.createElement("button",{className:"big-button",onClick:function(){return W(r)}},"GO"),c===U&&l&&s.a.createElement("button",{className:"big-button",onClick:function(){return function(e){var t=z(),n=t.order;t.peers[n[0]].send(JSON.stringify({type:"MODE_SET",mode:G}))}()}},"STOP"))},Z=n(91),ee=n(90),te=function(e){var t=e.style,n=Object(u.useContext)($),r=Object(v.a)(n,2),a=r[0],c=r[1],o=a.audioOutput,i=a.myStream,l=a.peers,d=Object(u.useState)([]),f=Object(v.a)(d,2),m=f[0],p=f[1],S=Object(u.useState)(!1),j=Object(v.a)(S,2),h=j[0],I=j[1],w=Object(u.useState)(null),T=Object(v.a)(w,2),R=T[0],A=T[1],N=Object(u.useState)(null),_=Object(v.a)(N,2),k=_[0],x=_[1];Object(u.useEffect)((function(){i&&h&&function(){var e=Object(y.a)(g.a.mark((function e(){var t;return g.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,p(t);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()()}),[i,h]),Object(u.useEffect)((function(){(function(){var e=Object(y.a)(g.a.mark((function e(){var t;return g.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.getUserMedia({audio:{deviceId:R&&{exact:R},autoGainControl:{exact:!1},echoCancellation:!1,noiseSuppression:{exact:!1}},video:{deviceId:k&&{exact:k}}});case 2:D(t=e.sent),i&&Object.values(l).forEach((function(e){M(e),C(e,t)})),c({type:"MY_STREAM_SET",stream:t});case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}})()()}),[R,k]);var L=["audioinput","audiooutput","videoinput"],U=["Audio Input","Audio Output","Video Input"],G=[[R,A],[o,function(e){c({type:"AUDIO_OUTPUT_SET",deviceId:e})}],[k,x]],P=m.reduce((function(e,t){var n=t.deviceId,r=t.kind,a=L.indexOf(r);return[].concat(Object(E.a)(e.slice(0,a)),[Object(b.a)({},e[a],Object(O.a)({},n,t))],Object(E.a)(e.slice(a+1)))}),[{},{},{}]);return s.a.createElement("section",{className:"av-setup",style:t},h?s.a.createElement(s.a.Fragment,null,P.map((function(e,t){var n=Object.values(e);if(0===n.length)return null;var r=U[t],a=Object(v.a)(G[t],2),c=a[0],o=a[1];return s.a.createElement("label",{key:r},r,s.a.createElement("select",{onChange:function(e){return o(e.target.value)},value:c||"default"},n.map((function(e){var t=e.deviceId,n=e.label;return s.a.createElement("option",{key:t,value:t},n)}))))})),s.a.createElement("button",{onClick:function(){return I(!1)}},"x")):s.a.createElement("button",{onClick:function(){return I(!0)}},"Audio/Video settings"))},ne=function(){var e=Object(u.useContext)($),t=Object(v.a)(e,1)[0].countdown;return s.a.createElement("span",{className:"countdown"},t)};function re(e){var t=Object(u.useRef)();return Object(u.useEffect)((function(){t.current=e}),[e]),t.current}var ae=function(e){e.id,e.isMe;var t=e.setVideoAspectRatio,n=e.stream,r=Object(u.useContext)($),a=Object(v.a)(r,1)[0].audioOutput,c=re(n),o=re(a),i=Object(u.useCallback)((function(e){e&&(n!==c&&(e.addEventListener("loadedmetadata",(function(e){var n=e.target;t(n.videoWidth/n.videoHeight)})),"srcObject"in e?e.srcObject=n:e.src=URL.createObjectURL(n)),a&&a!==o&&e.setSinkId(a))}),[a,n]);return n?s.a.createElement("video",{autoPlay:!0,ref:i}):null},ce=function(e){var t=e.col,n=e.id,r=e.isMe,a=(e.numColumns,e.orderNumber),c=e.row,o=e.stream,i=Object(u.useContext)($),l=Object(v.a)(i,2),d=l[0],f=l[1],m=d.iAmInitiator,O=d.mode,b=d.myId,p=d.order,S=Object(u.useRef)(null),j=Object(Z.a)({item:{id:n,type:"participant"},canDrag:function(){return m&&[x,G].includes(O)},collect:function(e){return{isDragging:e.isDragging()}}}),g=Object(v.a)(j,2),y=g[0].isDragging,I=g[1],w=Object(ee.a)({accept:"participant",drop:function(e){h({type:"ORDER_SET",fromId:b,order:p})},hover:function(e){var t=e.id;if(t!==n){var r=p.indexOf(n),a=p.indexOf(t),c=Object(E.a)(p);c[r]=t,c[a]=n,f({type:"ORDER_SET",order:c})}}}),T=Object(v.a)(w,2)[1];I(S),T(S);var D={gridColumn:"".concat(t," / span 1"),gridRow:"".concat(c," / span 1"),opacity:y?.5:1},R=Object(u.useState)(null),A=Object(v.a)(R,2),N=A[0],_=A[1],k=Object(u.useState)(0),C=Object(v.a)(k,2),M=C[0],P=C[1],V=Object(u.useState)(0),B=Object(v.a)(V,2),W=B[0],J=B[1];Object(u.useEffect)((function(){var e=S.current;if(e&&N){var t=new ResizeObserver((function(e){e.forEach((function(e){var t=e.contentRect,n=t.width,r=t.height,a=r,c=a*N;c>n&&(a=(c=n)/N),P((n-c)/2),J((r-a)/2)}))}));return t.observe(e),function(){t.disconnect()}}}),[N]);var F=a>0&&N&&S.current,H={backgroundColor:(O===L?"yellow":O===U&&"red")||"green",left:"calc(".concat(M,"px + 1%)"),top:"calc(".concat(W,"px + 1%)")},q={right:H.left,top:H.top};return s.a.createElement("div",{ref:S,className:"video-draggable",style:D},s.a.createElement(ae,{id:n,isMe:r,setVideoAspectRatio:_,stream:o}),r&&s.a.createElement(te,{style:q}),F&&s.a.createElement("span",{className:"order-number",style:H},a),O===L&&r&&s.a.createElement(ne,null))},oe=function(){var e=Object(u.useContext)($),t=Object(v.a)(e,1)[0],n=t.myId,r=t.myStream,a=t.order,c=t.streams,o=Object.values(c).length+1,i=Math.ceil(Math.sqrt(o)),l=Math.ceil(o/i),d=100/i,f=100/l,m={gridTemplateColumns:"repeat(".concat(i,", ").concat(d,"%)"),gridTemplateRows:"repeat(".concat(i,", ").concat(f,"%)")},O=function(e){var t=a.indexOf(e)+1,n=Math.ceil(t/i);return{col:t-(n-1)*i,orderNumber:t,row:n}};return s.a.createElement("main",{className:"video-grid",style:m},s.a.createElement(ce,Object.assign({id:n,isMe:!0,stream:r},O(n))),Object.entries(c).map((function(e){var t=Object(v.a)(e,2),n=t[0],r=t[1];return s.a.createElement(ce,Object.assign({key:n,id:n,stream:r},O(n)))})))},ie=function(e){var t=e.onClick;return s.a.createElement(s.a.Fragment,null,s.a.createElement("div",null,"Welcome. Let's make the connections."),s.a.createElement("div",null,"First, enable your audio and video. Before you click the button, put on headphones so there's no feedback!"),s.a.createElement("button",{onClick:t},"Let's go!"))},ue=function(){var e=Object(u.useContext)($),t=Object(v.a)(e,1)[0];console.log("STATE",t);var n=Object(u.useState)(!0),r=Object(v.a)(n,2),a=r[0],c=r[1];return a?s.a.createElement(ie,{onClick:function(){return c(!1)}}):s.a.createElement(s.a.Fragment,null,s.a.createElement(oe,null),s.a.createElement(X,null),s.a.createElement(Q,null))},se=function(e){var t=e.children,n=Object(u.useContext)($),r=Object(v.a)(n,2),a=r[0],c=r[1],o=a.myStream,i=re(o),s=new URLSearchParams(window.location.search).get("server");return Object(u.useEffect)((function(){o&&!i&&s&&I(s,c)}),[o,i,s]),s?t:"You have to have a server. Sorry, that's just the way it is."},le=(n(86),function(){return s.a.createElement(K,null,s.a.createElement(se,null,s.a.createElement(f.a,{backend:m.a},s.a.createElement(ue,null))))});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));d.a.render(s.a.createElement(le,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[44,1,2]]]);
//# sourceMappingURL=main.a1597fbf.chunk.js.map